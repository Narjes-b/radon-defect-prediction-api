{% extends "repository_template.html" %}

{% block body %}

<div class="container">
  <div class="card-deck mb-3 text-center">
    <div class="card mb-4 box-shadow shadow p-3 mb-5 bg-white rounded">
      <div class="card-body">
        <h1 class="card-title pricing-card-title"><small class="text-muted">Mine repository</small></h1>
        <ul class="list-unstyled">
          <li>...</li>
        </ul>
        <button class="btn btn-lg btn-block btn-outline-primary" data-toggle="modal" data-target="#modal-mine">Mine</button>
      </div>
    </div>
    <div class="card mb-4 box-shadow  shadow p-3 mb-5 bg-white rounded">
      <div class="card-body">
        <h1 class="card-title pricing-card-title"><small class="text-muted"> Train a model </small></h1>
        <ul class="list-unstyled">
          <li> ... </li>
        </ul>
        <a class="btn btn-lg btn-block btn-outline-primary" href="repositories" role="button">Train</a>
      </div>
    </div>
  </div>
</div>

<!-- MODAL MINE -->
<div class="modal" id="modal-mine" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <p class="modal-title text-uppercase">Mining settings</p>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
          <div class="form-group">
            <label>Bug-related labels</label><br/>
            <input id="input-labels" type="password" class="form-control" placeholder="Separate labels by comma (e.g., bug, type: bug, bugfix)">
            <small  class="form-text text-muted">These are the issue labels that will be used to identify bug-related issues.</small>
          </div>

          <div class="form-group">
            <label>Regex</label><br/>
            <input id="input-regex" type="password" class="form-control" placeholder="e.g., (bug|fix|error|crash|problem|fail|defect|patch)">
            <small class="form-text text-muted">This is the regular expression that will be used to match fixing-commit messages.</small>
          </div>

          <div class="form-group">
            <label>Path to the cloned repository</label><br/>
            <input id="input-path-to-clone" type="text" class="form-control" placeholder="Path to the cloned repository">
            <small id="path_to_clones_help" class="form-text text-muted">This is the folder of the cloned repository.</small>
          </div>

          <div class="form-group">
            <label>Github access token</label>
            <input id="input-svc-api-token" type="password" class="form-control" placeholder="Personal access token">
          </div>
      </div>

      <div class="modal-footer">
        <button id="btn-mine" type="button" class="btn btn-primary btn-md btn-block">Mine</button>
      </div>
    </div>
  </div>
</div>


{% endblock %}

{% block javascript %}

<script>
$(document).ready(function(){

  $("#btn-mine").click(function(){

    // Check the mandatory fields are not empty
    if(!($("#input-path-to-clone").val() || $("#input-svc-api-token").val())){
        toastr.options.preventDuplicates = true
        toastr.options.positionClass = "toast-bottom-right"
        toastr.warning('The path to clone and the personal access token are mandatory!')
        return
    }

    // Call { url repository_mine }
    $.ajax({
         url: "https://gitlab.com/api/v4/projects/",
         type: "GET",
         headers: {'PRIVATE-TOKEN': 'wrong token' },
         success: function(response) {
            toastr.clear()
            toastr.options = {
                "closeButton": true,
                "positionClass": "toast-bottom-right",
                "showMethod": "fadeIn",
                "hideMethod": "fadeOut"
            }
            toastr['success']('Mining ended.', 'Hooray!')
         }
    }).fail(function (msg) {
        toastr.remove()
        toastr.options = {
            "closeButton": true,
            "positionClass": "toast-bottom-right",
            "showMethod": "fadeIn",
            "hideMethod": "fadeOut"
        }
        toastr['error']('Something wrong occurred!', 'Error')
    });

    // finally, dismiss modal
    $('#modal-mine').modal('hide');
    $('body').removeClass('modal-open');
    $('.modal-backdrop').remove();

    // Notify
    toastr.options = {
        "closeButton": true,
        "positionClass": "toast-bottom-right",
        "timeOut": 0,
        "extendedTimeOut": 0,
        "showMethod": "fadeIn",
        "hideMethod": "fadeOut"
    }
    toastr['info']('I am mining... <span><i class="fa fa-spinner fa-pulse"></i></span>', 'Please wait')
  });

});
</script>
{% endblock %}


